<!-- AUTH + FIRESTORE INTEGRATED VERSION OF index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Meesa WA</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #1e1e1e; color: #eee; padding: 20px; }
    #chat { background: #2a2a2a; border: 1px solid #444; height: 50vh; overflow-y: auto; padding: 10px; margin: 10px 0; }
    input, button { font-size: 16px; padding: 10px; margin: 5px 0; border: none; border-radius: 4px; }
    #inputArea { display: flex; gap: 5px; }
    .message { margin-bottom: 5px; }
    .timestamp { font-size: 0.8em; color: #bbb; margin-left: 10px; }
  </style>
</head>
<body>
<h2>Meesa Chat</h2>
<div id="loginBox">
  <button onclick="signIn()">Sign in with Google</button>
</div>
<div id="userInfo" style="display: none;">
  <p id="welcome"></p>
  <input id="room" placeholder="Room (e.g. general)" />
  <button onclick="startChat()">Join</button>
</div>
<div id="chat" style="display: none;"></div>
<div id="inputArea" style="display: none;">
  <input id="message" placeholder="Type a message" onkeydown="if(event.key==='Enter') sendMessage()" />
  <button onclick="sendMessage()">Send</button>
</div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyD...abc",
  authDomain: "meesa-6cc00.firebaseapp.com",
  projectId: "meesa-6cc00",
  storageBucket: "meesa-6cc00.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abc123def456"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let client, username = '', room = '';

function signIn() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    const user = result.user;
    username = user.displayName || user.email;
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('userInfo').style.display = 'block';
    document.getElementById('welcome').textContent = `Welcome, ${username}`;
  });
}

function startChat() {
  room = document.getElementById('room').value.trim() || 'general';
  document.getElementById('chat').style.display = 'block';
  document.getElementById('inputArea').style.display = 'flex';

  loadHistory();
  client = mqtt.connect('wss://241024dacc644661b296a5b1b68f1390.s1.eu.hivemq.cloud:8884/mqtt', {
    username: 'Meesa',
    password: 'MeesaPassword42'
  });

  client.on('connect', () => {
    client.subscribe(`chat/MushRoom/${room}/public`);
  });

  client.on('message', (topic, message) => {
    const payload = JSON.parse(message.toString());
    if (topic.endsWith('/public') && payload.username !== username) {
      appendMessage(`${payload.username}: ${payload.text}`, payload.timestamp);
    }
  });
}

function sendMessage() {
  const msg = document.getElementById('message').value.trim();
  if (!msg) return;
  const timestamp = new Date().toISOString();
  const id = 'msg_' + Date.now();
  document.getElementById('message').value = '';

  client.publish(`chat/MushRoom/${room}/public`, JSON.stringify({ username, text: msg, timestamp, id }));
  db.collection("messages").doc(id).set({ username, room, text: msg, timestamp });
  appendMessage(`${username}: ${msg}`, timestamp);
}

function appendMessage(text, timestamp) {
  const chat = document.getElementById('chat');
  const p = document.createElement('p');
  p.className = 'message';
  const timeString = timestamp ? `<span class="timestamp">${new Date(timestamp).toLocaleTimeString()}</span>` : '';
  p.innerHTML = `${text} ${timeString}`;
  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
}

function loadHistory() {
  db.collection("messages")
    .where("room", "==", room)
    .orderBy("timestamp", "asc")
    .limit(50)
    .get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        appendMessage(`${data.username}: ${data.text}`, data.timestamp);
      });
    });
}
</script>
</body>
</html>
